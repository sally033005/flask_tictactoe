{% extends "base.html" %}
{% block content %}

<!-- ================= GAME RESULT MODAL ================= -->
<div id="result-overlay" class="result-overlay hidden">
    <div class="result-modal">
        <h2 id="result-title">Game Over</h2>
        <p id="result-message"></p>

        <div class="result-actions">
            <button id="play-again-btn" class="btn btn-primary">Play Again</button>
            <button id="exit-btn" class="btn">Exit</button>
        </div>
    </div>
</div>

<div class="container">

    <p style="text-align:center;">
        <strong>{{ player_name }}</strong> (X)
        vs
        <strong>{{ ai_name }}</strong> (O)
    </p>

    {% if mode == '1' %}
        <p>Difficulty: {{ session.get('difficulty', 'hard').capitalize() }}</p>
    {% endif %}

    <!-- ================= GAME BOARD ================= -->
    <div class="board">
        {% for i in range(9) %}
            {% if board[i] == ' ' %}
                <a href="{{ url_for('move', cell=i) }}" class="cell empty"></a>
            {% else %}
                <div class="cell filled {{ board[i].lower() }}">{{ board[i] }}</div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- ================= STATUS ================= -->
    <div id="status">
        <p id="current-turn">Current Turn: {{ current }}</p>
        <p id="wins">
            Wins: {{ player_name }} (X) - {{ wins['X'] }}
            |
            {{ ai_name }} (O) - {{ wins['O'] }}
        </p>
    </div>
</div>

<!-- ================= SHARED MODAL LOGIC ================= -->
<script>
    const overlay = document.getElementById("result-overlay");
    const titleEl = document.getElementById("result-title");
    const messageEl = document.getElementById("result-message");

    document.getElementById("play-again-btn").onclick = () => {
        window.location.href = "/reset";
    };

    document.getElementById("exit-btn").onclick = () => {
        fetch("/leave_game");
        window.location.href = "/";
    };

    function showResult(title, message) {
        titleEl.textContent = title;
        messageEl.textContent = message;
        overlay.classList.remove("hidden");
    }
</script>

<!-- ================= SINGLE PLAYER ================= -->
{% if mode == '1' %}
<script>
    const winner = "{{ winner }}";
    const draw = "{{ draw }}";

    if (winner && winner !== "None") {
        const winnerName = winner === "X" ? "{{ player_name }}" : "{{ ai_name }}";
        showResult("üèÜ Victory!", `${winnerName} wins the game`);
    } 
    else if (draw === "True") {
        showResult("ü§ù Draw", "No one wins this round");
    }
</script>
{% endif %}

<!-- ================= ONLINE MULTIPLAYER ================= -->
{% if mode == '2' %}
<script>
    const gameId = "{{ code }}";
    let notificationShown = false;

    function updateBoard(board) {
        const cells = document.querySelectorAll(".cell");
        board.forEach((val, idx) => {
            if (cells[idx].classList.contains("filled")) return;
            if (val !== " ") {
                cells[idx].textContent = val;
                cells[idx].classList.add("filled", val.toLowerCase());
                cells[idx].classList.remove("empty");
                if (cells[idx].tagName === "A") cells[idx].href = "#";
            }
        });
    }

    async function fetchGameState() {
        try {
            const res = await fetch(`/game_state/${gameId}`);
            const data = await res.json();
            if (data.error) return;

            if (data.player_left && !notificationShown) {
                notificationShown = true;
                showResult("Player Left", `${data.left_player_name} has left the game`);
                return;
            }

            if (data.disconnected && !notificationShown) {
                notificationShown = true;
                showResult("Disconnected", `${data.disconnected_player_name} has disconnected`);
                return;
            }

            updateBoard(data.board);

            document.getElementById("current-turn").textContent =
                "Current Turn: " + data.current;

            const playerX = data.players.X;
            const playerO = data.players.O;

            document.getElementById("wins").textContent =
                `Wins: ${playerX} (X) - ${data.wins.X} | ${playerO} (O) - ${data.wins.O}`;

            if (data.winner && !notificationShown) {
                notificationShown = true;
                const winnerName = data.winner === "X" ? playerX : playerO;
                showResult("üèÜ Victory!", `${winnerName} wins the game`);
            }
            else if (data.draw && !notificationShown) {
                notificationShown = true;
                showResult("ü§ù Draw", "No one wins this round");
            }
        } catch (err) {
            console.error(err);
        }
    }

    setInterval(fetchGameState, 1000);

    window.addEventListener("beforeunload", () => {
        if (navigator.sendBeacon) {
            navigator.sendBeacon("/leave_game");
        }
    });
</script>
{% endif %}

{% endblock %}
