{% extends "base.html" %}
{% block content %}
<div class="container">

    <p style="text-align:center;">
        <strong>{{ player_name }}</strong> (X) vs <strong>{{ ai_name }}</strong> (O)
    </p>

    {% if mode == '1' %}
    <p>Difficulty: {{ session.get('difficulty', 'hard').capitalize() }}</p>
    {% endif %}


    <div class="board">
        {% for i in range(9) %}
        {% if board[i] == ' ' %}
        <a href="{{ url_for('move', cell=i) }}" class="cell empty"></a>
        {% else %}
        <div class="cell filled">{{ board[i] }}</div>
        {% endif %}
        {% endfor %}
    </div>

    <div id="status">
        <p id="current-turn">Current Turn: {{ current }}</p>
        <p id="wins">Wins: {{ player_name }} (X) - {{ wins['X'] }} | {{ ai_name }} (O) - {{ wins['O'] }}</p>
    </div>

    {% if mode == '1' %}
    <script>
        const winner = "{{ winner }}";
        const draw = "{{ draw }}";

        function askPlayAgain(message) {
            let again = confirm(message + "\n\nDo you want to play again?");
            if (again) {
                window.location.href = "/reset";
            } else {
                window.location.href = "/";
            }
        }

        if (winner && winner !== "None") {
            let msg = "Winner: " + (winner === 'X' ? "{{ player_name }}" : "{{ ai_name }}");
            askPlayAgain(msg);
        }
        else if (draw === "True") {
            askPlayAgain("It's a draw!");
        }
    </script>
    {% endif %}

    {% if mode == '2' %}
    <script>
        let mode = "{{ mode }}";
        let gameId = "{{ code }}" || "";  // empty string for 1-player mode

        function updateBoard(board) {
            const cells = document.querySelectorAll('.cell');
            board.forEach((val, idx) => {
                if (cells[idx].classList.contains('filled')) return;
                if (val !== ' ') {
                    cells[idx].textContent = val;
                    cells[idx].classList.add('filled');
                    cells[idx].classList.remove('empty');
                    if (cells[idx].tagName === 'A') cells[idx].href = '#';
                }
            });
        }

        async function fetchGameState() {
            try {
                const url = mode === '1' ? `/game_state/` : `/game_state/${gameId}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.error) return;

                // Update board
                updateBoard(data.board);

                // Update current turn
                document.getElementById('current-turn').textContent = "Current Turn: " + data.current;

                // Update wins
                let playerX = data.player_name || data.players.X;
                let playerO = data.ai_name || data.players.O;
                document.getElementById('wins').textContent =
                    `Wins: ${playerX} (X) - ${data.wins['X']} | ${playerO} (O) - ${data.wins['O']}`;

                // Show winner or draw
                if (data.winner) {
                    let winnerName = data.winner === 'X' ? playerX : playerO;
                    let again = confirm(`Winner: ${winnerName}\n\nDo you want to play again?`);
                    if (again) {
                        window.location.href = "/reset";
                    } else {
                        window.location.href = "/";
                    }
                }
                else if (data.draw) {
                    let again = confirm("It's a draw!\n\nDo you want to play again?");
                    if (again) {
                        window.location.href = `/reset/${gameId}`;
                    } else {
                        window.location.href = "/";
                    }
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Poll every 1 second
        setInterval(fetchGameState, 1000);
    </script>
    {% endif %}
</div>
{% endblock %}